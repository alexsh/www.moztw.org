var _SearchParams=function(search){var params=this.params={};search=search||location.search||"";search=search.match(/^\??(.*)/)[1];search=search?search.split(/[&;]/m):[];$.each(search,function(index,param){param=param.split("=");var key=param[0];var value=param[1];params[key]=!isNaN(value)?parseFloat(value):value})};_SearchParams.prototype.get=function(key){return this.params[key]};_SearchParams.prototype.set=function(key,value){this.params[key]=!isNaN(value)?parseFloat(value):value};_SearchParams.prototype.has=function(key){return key in this.params};_SearchParams.prototype.remove=function(key){delete this.params[key]};_SearchParams.prototype.toString=function(){return $.map(this.params,function(value,key){return[encodeURIComponent(key),encodeURIComponent(value)].join("=")}).join("&")};_SearchParams.prototype.utmParams=function(){var utms={};$.each(this.params,function(key,val){if(key.indexOf("utm_")===0){utms[key]=val}});return utms};_SearchParams.prototype.utmParamsFxA=function(pathname){pathname=pathname||window.location.pathname||"";var utms=this.utmParams();if(!utms.utm_campaign){utms.utm_campaign="page referral - not part of a campaign"}var matches=pathname.match(/\/[\w-]+(\/.*)$/);if(matches&&matches.length>1){utms.utm_content=matches[1]}return utms};if(typeof Mozilla==="undefined"){var Mozilla={}}(function(){"use strict";var StubAttribution={};StubAttribution.COOKIE_CODE_ID="moz-stub-attribution-code";StubAttribution.COOKIE_SIGNATURE_ID="moz-stub-attribution-sig";StubAttribution.withinAttributionRate=function(){return Math.random()<StubAttribution.getAttributionRate()?true:false};StubAttribution.getAttributionRate=function(){var rate=$("html").attr("data-stub-attribution-rate");return isNaN(rate)?0:Math.min(Math.max(parseFloat(rate),0),1)};StubAttribution.hasCookie=function(){return Mozilla.Cookies.hasItem(StubAttribution.COOKIE_CODE_ID)&&Mozilla.Cookies.hasItem(StubAttribution.COOKIE_SIGNATURE_ID)};StubAttribution.setCookie=function(data){if(!data.attribution_code||!data.attribution_sig){return}var date=new Date;date.setTime(date.getTime()+1*24*60*60*1e3);var expires=date.toUTCString();Mozilla.Cookies.setItem(StubAttribution.COOKIE_CODE_ID,data.attribution_code,expires,"/");Mozilla.Cookies.setItem(StubAttribution.COOKIE_SIGNATURE_ID,data.attribution_sig,expires,"/")};StubAttribution.getCookie=function(){return{attribution_code:Mozilla.Cookies.getItem(StubAttribution.COOKIE_CODE_ID),attribution_sig:Mozilla.Cookies.getItem(StubAttribution.COOKIE_SIGNATURE_ID)}};StubAttribution.updateBouncerLinks=function(data){if(!data.attribution_code||!data.attribution_sig||!StubAttribution.meetsRequirements()){return}$(".download-list .download-link, .download-platform-list .download-link").each(function(){var version;if(this.href&&this.href.indexOf("/firefox/new/?scene=2")===-1){version=$(this).data("downloadVersion");if(version&&(version==="win"||version==="win64")){this.href=Mozilla.StubAttribution.appendToDownloadURL(this.href,data)}}})};StubAttribution.appendToDownloadURL=function(url,data){if(!data.attribution_code||!data.attribution_sig){return url}$.each(data,function(key,val){if(key==="attribution_code"||key==="attribution_sig"){url+=(url.indexOf("?")>-1?"&":"?")+key+"="+val}});return url};StubAttribution.onRequestSuccess=function(data){if(data.attribution_code&&data.attribution_sig){StubAttribution.updateBouncerLinks(data);StubAttribution.setCookie(data)}};StubAttribution.requestAuthentication=function(data){var SERVICE_URL=window.location.protocol+"//"+window.location.host+"/en-US/firefox/stub_attribution_code/";$.get(SERVICE_URL,data).done(StubAttribution.onRequestSuccess)};StubAttribution.getAttributionData=function(ref){var params=(new window._SearchParams).utmParams();var referrer=typeof ref!=="undefined"?ref:document.referrer;var utmCount=0;for(var utm in params){if(params.hasOwnProperty(utm)){utmCount+=1}}if(utmCount===0&&(typeof referrer==="undefined"||referrer==="")){return false}return{utm_source:params.utm_source,utm_medium:params.utm_medium,utm_campaign:params.utm_campaign,utm_content:params.utm_content,referrer:referrer}};StubAttribution.isFirefoxNewScene2=function(location){location=typeof location!=="undefined"?location:window.location.href;return location.indexOf("/firefox/new/")>-1&&location.indexOf("scene=2")>-1};StubAttribution.meetsRequirements=function(){if(typeof window.site==="undefined"||typeof Mozilla.Cookies==="undefined"){return false}if(!Mozilla.Cookies.enabled()){return false}if(window.site.platform!=="windows"){return false}if(window.site.needsSha1()){return false}if(window._dntEnabled()){return false}return true};StubAttribution.init=function(){var data={};if(!StubAttribution.meetsRequirements()){return}if(StubAttribution.hasCookie()){data=StubAttribution.getCookie();StubAttribution.updateBouncerLinks(data)}else if(!StubAttribution.isFirefoxNewScene2()){data=StubAttribution.getAttributionData();if(data&&StubAttribution.withinAttributionRate()){StubAttribution.requestAuthentication(data)}}};window.Mozilla.StubAttribution=StubAttribution})();(function(){"use strict";Mozilla.StubAttribution.init()})();
